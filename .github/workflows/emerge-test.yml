name: 'emerge test all ebuilds'

on:
  workflow_dispatch:
    inputs:
      grep-ebuilds:
        description: 'Which ebuilds to build'
        required: true
        default: 'all'
  schedule:
    - cron: '17 20 * * *'  # @Daily

env:
  DEFAULT_EBUILDS: 'all'

jobs:
  list-all-ebuilds:
    outputs:
      matrix: ${{ steps.list-all-ebuilds.outputs.matrix }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/antonfischl1980/gentoo-ci:main
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    # emerge --sync not needed in this run

    - name: repos.conf/icinga
      run: |
        mkdir -p /etc/portage/repos.conf/
        echo -en "[icinga]\nlocation = " >/etc/portage/repos.conf/icinga.conf
        pwd -P >> /etc/portage/repos.conf/icinga.conf
        cat /etc/portage/repos.conf/*.conf

    - name: list-all-ebuilds
      id: list-all-ebuilds
      run: |
        equery --no-color l -o "*/*::icinga" -F '=$cpv' | \
          (
            if [ "${{ github.event.inputs.grep-ebuilds || env.DEFAULT_EBUILDS }}" == "all"  ];then
              grep -vf .github/workflows/emerge-test.filter
            else
              grep "${{ github.event.inputs.grep-ebuilds }}"
            fi
          ) | \
          sort -u > /todo.lst
        cat /todo.lst
        echo -n "::set-output name=matrix::"
        jq --compact-output --monochrome-output --raw-input --slurp 'split("\n") | map(select(. != ""))' /todo.lst



  emerge-ebuild:
    needs: list-all-ebuilds
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/antonfischl1980/gentoo-ci:main
      options: --privileged
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        ebuild: ${{ fromJSON(needs.list-all-ebuilds.outputs.matrix) }}

    steps:
    - name: verify variables
      run: |
        echo "ebuild: ${{ matrix.ebuild }}"

    - name: Get Date
      id: get-date
      run: |
        echo "::set-output name=datetime::$(/bin/date -u "+%Y%m%d-%H%M%S")"

    - name: Checkout code
      uses: actions/checkout@v3

    - name: setup portage
      run: |
        mkdir -p /etc/portage/repos.conf/
        echo -en "[icinga]\nlocation = " >/etc/portage/repos.conf/icinga.conf
        pwd -P >> /etc/portage/repos.conf/icinga.conf
        cat /etc/portage/repos.conf/*.conf
        echo 'FEATURES="${FEATURES} buildpkg binpkg-multi-instance getbinpkg"' >> /etc/portage/make.conf
        echo "make.conf:"
        cat /etc/portage/make.conf
        mkdir -p /etc/portage/package.license
        cat .github/workflows/emerge-test/package.license >> /etc/portage/package.license/90_SETUP
        mkdir -p /etc/portage/package.mask
        cat .github/workflows/emerge-test/package.mask >> /etc/portage/package.mask/90_SETUP
        eselect profile set 'icinga:default/linux/amd64/17.1/no-multilib/icinga'

    - name: emerge-sync
      run: |
        sudo -u portage git -C /var/db/repos/gentoo pull
        emerge --sync

    - uses: actions/cache@v3
      name: Cache binpkg
      with:
        path: /var/cache/binpkgs/
        key: ${{ runner.os }}-binpkg-${{ steps.get-date.outputs.datetime }}
        restore-keys: |
          ${{ runner.os }}-binpkg-

    - name: emerge ${{ matrix.ebuild }}
      run: |
        echo "${{ matrix.ebuild }} ~amd64" >/etc/portage/package.accept_keywords/99_TEST
        emerge -t1v --jobs=4 "${{ matrix.ebuild }}"



  eclean-packages:
    needs: emerge-ebuild
    if: ${{ always() && !cancelled() }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/antonfischl1980/gentoo-ci:main
      options: --privileged
    steps:

    - name: Get Date
      id: get-date
      run: |
        echo "::set-output name=datetime::$(/bin/date -u "+%Y%m%d-%H%M%S")"
    
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: setup portage
      run: |
        mkdir -p /etc/portage/repos.conf/
        echo -en "[icinga]\nlocation = " >/etc/portage/repos.conf/icinga.conf
        pwd -P >> /etc/portage/repos.conf/icinga.conf
        cat /etc/portage/repos.conf/*.conf
        echo 'FEATURES="${FEATURES} buildpkg binpkg-multi-instance getbinpkg"' >> /etc/portage/make.conf
        echo "make.conf:"
        cat /etc/portage/make.conf
        mkdir -p /etc/portage/package.license
        cat .github/workflows/emerge-test/package.license >> /etc/portage/package.license/90_SETUP
        mkdir -p /etc/portage/package.mask
        cat .github/workflows/emerge-test/package.mask >> /etc/portage/package.mask/90_SETUP
        eselect profile set 'icinga:default/linux/amd64/17.1/no-multilib/icinga'

    - name: emerge-sync
      run: |
        sudo -u portage git -C /var/db/repos/gentoo pull
        emerge --sync

    - uses: actions/cache@v3
      name: Cache binpkg
      with:
        path: /var/cache/binpkgs/
        key: ${{ runner.os }}-binpkg-${{ steps.get-date.outputs.datetime }}
        restore-keys: |
          ${{ runner.os }}-binpkg-
    
    - name: list binpkgs alphabetically
      run: |
        find /var/cache/binpkgs/ -type f -print0|xargs -r0 ls -la
    
    - name: list binpkgs by modtime
      run: |
        find /var/cache/binpkgs/ -type f -print0|xargs -r0 ls -latr
    
    - name: eclean packages
      run: |
        find /var/cache/binpkgs/ -type f -printf '%T@ %p\0' | sort -z | sed -zn '1,10s/[^ ]\{1,\} //p' | xargs -r0 rm -v
        find /var/cache/binpkgs/dev-lang/go* -typed -print0 | xargs -r0 rm -Rv
        cd /var/cache/binpkgs/
        emaint binhost -f
        eclean -v packages
